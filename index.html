<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>🚀 MARIOPRO 3D Viewer + AR</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #1a1a1a;
            color: white;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        .container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* Three.js Canvas */
        #canvas {
            width: 100%;
            height: 100%;
            display: block;
            background: #222;
            touch-action: none;
        }

        /* AR Viewer */
        #arViewer {
            width: 100%;
            height: 100%;
            display: none;
            background: #f5f5f5;
            touch-action: none;
        }

        .ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        /* Header compatto mobile */
        .header {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.95);
            padding: 15px;
            border-radius: 12px;
            pointer-events: auto;
            backdrop-filter: blur(15px);
            border: 2px solid #667eea;
            text-align: center;
            max-height: 80px;
            overflow: hidden;
        }

        .header h1 {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(45deg, #667eea, #764ba2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2px;
        }

        .header p {
            font-size: 0.8rem;
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Controlli mobile ottimizzati */
        .controls {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.95);
            padding: 15px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
            backdrop-filter: blur(15px);
            border: 2px solid #667eea;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Pulsanti ottimizzati per touch */
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 18px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s ease;
            width: 100%;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.98);
            background: linear-gradient(45deg, #5a6fd8, #6a4190);
        }

        .btn.secondary {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
        }

        .btn.secondary:active {
            background: rgba(255, 255, 255, 0.25);
        }

        .btn.ar {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            animation: pulse 2s infinite;
            font-weight: bold;
        }

        .btn:disabled {
            opacity: 0.5;
            transform: none !important;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }

        /* Selettore modalità mobile */
        .mode-selector {
            position: fixed;
            top: 100px;
            right: 10px;
            background: rgba(0, 0, 0, 0.95);
            padding: 10px;
            border-radius: 12px;
            pointer-events: auto;
            backdrop-filter: blur(15px);
            border: 2px solid #667eea;
            display: none;
            min-width: 140px;
        }

        .mode-selector.visible {
            display: block;
        }

        .mode-btn {
            display: block;
            width: 100%;
            margin: 4px 0;
            padding: 12px 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            text-align: center;
        }

        .mode-btn:active {
            background: rgba(255, 255, 255, 0.2);
        }

        .mode-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-color: transparent;
        }

        /* Area upload mobile */
        .file-input-area {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: calc(100vw - 20px);
            max-width: 400px;
            background: rgba(0, 0, 0, 0.98);
            padding: 30px 20px;
            border-radius: 20px;
            border: 3px dashed #667eea;
            backdrop-filter: blur(20px);
            pointer-events: auto;
            text-align: center;
            max-height: 80vh;
            overflow-y: auto;
        }

        .file-input-area.hidden {
            display: none !important;
        }

        .file-input-area.dragover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.2);
            transform: translate(-50%, -50%) scale(1.02);
        }

        /* Input file mobile ottimizzato */
        #fileInput {
            width: 100%;
            padding: 20px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #667eea;
            border-radius: 12px;
            color: white;
            margin: 20px 0;
            cursor: pointer;
            min-height: 60px;
        }

        #fileInput::-webkit-file-upload-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            margin-right: 15px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
        }

        /* Info panel mobile */
        .info {
            position: fixed;
            top: 100px;
            left: 10px;
            background: rgba(0, 0, 0, 0.95);
            padding: 15px;
            border-radius: 12px;
            pointer-events: auto;
            display: none;
            backdrop-filter: blur(15px);
            border: 2px solid #667eea;
            max-width: calc(50vw - 15px);
            font-size: 14px;
        }

        .info h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #667eea;
        }

        .info div {
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }

        /* Device info mobile */
        .device-info {
            position: fixed;
            bottom: 220px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            pointer-events: auto;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }

        /* Status e messaggi */
        .status {
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
        }

        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.15);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 107, 107, 0.3);
            font-size: 14px;
        }

        .loading {
            color: #667eea;
            font-size: 14px;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 15px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Instructions mobile */
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 14px;
            line-height: 1.4;
        }

        .instructions h3 {
            color: #ffeb3b;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .instructions ul {
            list-style-position: inside;
            padding-left: 0;
        }

        .instructions li {
            margin-bottom: 4px;
        }

        /* Model-viewer mobile */
        model-viewer {
            --poster-color: transparent;
            --progress-bar-color: #667eea;
        }

        model-viewer::part(default-ar-button) {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52) !important;
            color: white !important;
            border: none !important;
            border-radius: 25px !important;
            padding: 12px 24px !important;
            font-weight: bold !important;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3) !important;
            animation: pulse 2s infinite !important;
            font-size: 16px !important;
        }

        /* Landscape orientation fixes */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .header {
                top: 5px;
                padding: 10px;
                max-height: 60px;
            }
            
            .header h1 {
                font-size: 1rem;
            }
            
            .header p {
                font-size: 0.7rem;
            }
            
            .controls {
                bottom: 5px;
                padding: 10px;
                max-height: 120px;
            }
            
            .btn {
                padding: 12px 15px;
                min-height: 40px;
                font-size: 14px;
            }
            
            .device-info {
                bottom: 130px;
                font-size: 10px;
            }
        }

        /* Safe area per iPhone con notch */
        @supports (padding: max(0px)) {
            .header {
                top: max(10px, env(safe-area-inset-top));
                left: max(10px, env(safe-area-inset-left));
                right: max(10px, env(safe-area-inset-right));
            }
            
            .controls {
                bottom: max(10px, env(safe-area-inset-bottom));
                left: max(10px, env(safe-area-inset-left));
                right: max(10px, env(safe-area-inset-right));
            }
        }

        /* Loading overlay mobile */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .loading-overlay.hidden {
            display: none;
        }

        /* Gesture hints */
        .gesture-hint {
            position: fixed;
            bottom: 50%;
            left: 50%;
            transform: translate(-50%, 50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            text-align: center;
            pointer-events: none;
            opacity: 0;
            animation: fadeInOut 3s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Three.js Canvas -->
        <canvas id="canvas"></canvas>
        
        <!-- AR Viewer -->
        <model-viewer
            id="arViewer"
            alt="Modello 3D MARIOPRO"
            ar
            ar-modes="webxr scene-viewer quick-look"
            camera-controls
            touch-action="pan-y"
            auto-rotate
            auto-rotate-delay="4000"
            shadow-intensity="1"
            camera-orbit="45deg 75deg auto"
            min-camera-orbit="auto auto 2m"
            max-camera-orbit="auto auto 16m">
        </model-viewer>
        
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <p>Inizializzazione MARIOPRO...</p>
        </div>
        
        <div class="ui">
            <!-- Header compatto -->
            <div class="header">
                <h1 id="title">🚀 MARIOPRO AR</h1>
                <p id="subtitle">3D Viewer + Realtà Aumentata</p>
            </div>

            <!-- Mode selector -->
            <div class="mode-selector" id="modeSelector">
                <button class="mode-btn active" id="threejsMode">🎮 3D</button>
                <button class="mode-btn" id="arMode">📱 AR</button>
            </div>

            <!-- Info panel compatta -->
            <div class="info" id="info">
                <h3>📊 Info</h3>
                <div>
                    <span>Triangoli:</span>
                    <span id="triangles">-</span>
                </div>
                <div>
                    <span>Vertici:</span>
                    <span id="vertices">-</span>
                </div>
                <div>
                    <span>AR:</span>
                    <span id="arReady">-</span>
                </div>
            </div>

            <!-- Controlli ottimizzati mobile -->
            <div class="controls">
                <button class="btn" id="loadFileBtn">📂 Carica File 3D</button>
                <div style="display: flex; gap: 10px;">
                    <button class="btn secondary" id="resetBtn" style="display:none; flex: 1;">🔄 Reset</button>
                    <button class="btn secondary" id="wireframeBtn" style="display:none; flex: 1;">🔲 Wire</button>
                </div>
                <button class="btn ar" id="arToggleBtn" style="display:none;">📱 Modalità AR</button>
            </div>

            <!-- Upload area -->
            <div class="file-input-area" id="fileInputArea">
                <div style="font-size: 2.5rem; margin-bottom: 15px;">📦</div>
                <h2 style="color: #667eea; margin-bottom: 15px; font-size: 1.5rem;">Carica modello</h2>
                
                <input type="file" id="fileInput" accept=".gltf,.glb,.dae">
                
                <div class="instructions">
                    <h3>🔍 AR Support</h3>
                    <ul style="text-align: left; font-size: 13px;">
                        <li>📱 <strong>Android:</strong> File GLB/GLTF</li>
                        <li>🍎 <strong>iOS:</strong> File GLB/USDZ</li>
                        <li>💻 <strong>Desktop:</strong> Solo 3D</li>
                        <li>📦 <strong>Max:</strong> 2GB</li>
                    </ul>
                </div>

                <div class="status" id="status"></div>
            </div>

            <!-- Device info -->
            <div class="device-info" id="deviceInfo">
                <span id="deviceType">📱 Rilevamento device...</span> |
                <span id="arSupport">🔍 Check AR...</span>
            </div>

            <!-- Gesture hint -->
            <div class="gesture-hint" id="gestureHint" style="display: none;">
                👆 Tocca e trascina per ruotare il modello
            </div>
        </div>
    </div>

    <!-- Three.js Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.140.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.140.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.140.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.140.0/examples/js/loaders/ColladaLoader.js"></script>

    <!-- model-viewer for AR -->
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

    <script>
        console.log('📱 MARIOPRO Mobile AR - Inizializzazione');

        // Variabili globali
        let scene, camera, renderer, controls, model;
        let wireframeMode = false;
        let currentMode = 'threejs';
        let currentFileBlob = null;
        let currentFileName = '';
        let currentFileExtension = '';
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // Elementi DOM
        const canvas = document.getElementById('canvas');
        const arViewer = document.getElementById('arViewer');
        const fileInput = document.getElementById('fileInput');
        const fileInputArea = document.getElementById('fileInputArea');
        const status = document.getElementById('status');
        const info = document.getElementById('info');
        const modeSelector = document.getElementById('modeSelector');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Nascondi loading dopo inizializzazione
        setTimeout(() => {
            loadingOverlay.classList.add('hidden');
        }, 2000);

        // Device detection ottimizzato mobile
        function detectDevice() {
            const isAndroid = /Android/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isChrome = /Chrome/i.test(navigator.userAgent);
            const isSafari = /Safari/i.test(navigator.userAgent) && !isChrome;

            let deviceType = 'Desktop';
            let arSupported = false;

            if (isAndroid && isChrome) {
                deviceType = 'Android Chrome';
                arSupported = true;
            } else if (isIOS && isSafari) {
                deviceType = 'iOS Safari';
                arSupported = true;
            } else if (isAndroid) {
                deviceType = 'Android';
            } else if (isIOS) {
                deviceType = 'iOS';
            }

            // Aggiorna UI
            document.getElementById('deviceType').textContent = deviceType;
            document.getElementById('arSupport').textContent = arSupported ? 'Supportato ✅' : 'Non supportato';

            console.log('📱 Device:', deviceType, '| AR:', arSupported);
            return { isAndroid, isIOS, isChrome, isSafari, arSupported };
        }

        // Three.js inizializzazione mobile-ottimizzata
        function initThree() {
            console.log('🎮 Init Three.js mobile...');

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(4, 4, 4);

            renderer = new THREE.WebGLRenderer({ 
                canvas, 
                antialias: !isMobile, // No antialias su mobile per performance
                powerPreference: isMobile ? 'low-power' : 'high-performance'
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, isMobile ? 2 : 3));
            renderer.shadowMap.enabled = !isMobile; // No shadows su mobile per performance

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.1; // Più responsivo su mobile
            controls.touches = {
                ONE: THREE.TOUCH.ROTATE,
                TWO: THREE.TOUCH.DOLLY_PAN
            };

            setupLighting();
            console.log('✅ Three.js mobile ready');
        }

        function setupLighting() {
            // Illuminazione semplificata per mobile
            scene.add(new THREE.AmbientLight(0x404040, 0.6));
            
            const light1 = new THREE.DirectionalLight(0xffffff, 0.8);
            light1.position.set(10, 10, 5);
            if (!isMobile) light1.castShadow = true;
            scene.add(light1);

            if (!isMobile) {
                const light2 = new THREE.DirectionalLight(0xffffff, 0.3);
                light2.position.set(-10, -10, -5);
                scene.add(light2);
            }
        }

        // Eventi ottimizzati mobile
        function setupEvents() {
            console.log('🔧 Setup eventi mobile...');

            // Previeni comportamenti default mobile
            document.addEventListener('touchmove', (e) => {
                if (e.touches.length > 1) e.preventDefault();
            }, { passive: false });

            // File input
            fileInput.addEventListener('change', handleFileSelect);

            // Controlli
            document.getElementById('resetBtn').addEventListener('click', resetCamera);
            document.getElementById('wireframeBtn').addEventListener('click', toggleWireframe);
            document.getElementById('arToggleBtn').addEventListener('click', toggleMode);

            // Mode selector
            document.getElementById('threejsMode').addEventListener('click', () => switchMode('threejs'));
            document.getElementById('arMode').addEventListener('click', () => switchMode('ar'));

            // Touch ottimizzato drag & drop
            setupDragAndDrop();
            window.addEventListener('resize', onWindowResize);
            window.addEventListener('orientationchange', () => {
                setTimeout(onWindowResize, 100);
            });

            console.log('✅ Eventi mobile configurati');
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                loadModel(files[0]);
                // Reset file input per consentire ricaricamento stesso file
                setTimeout(() => { fileInput.value = ''; }, 1000);
            }
        }

        function setupDragAndDrop() {
            if (!isMobile) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    document.addEventListener(eventName, preventDefaults, false);
                });

                document.addEventListener('drop', (event) => {
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        loadModel(files[0]);
                    }
                }, false);
            }
        }

        function preventDefaults(event) {
            event.preventDefault();
            event.stopPropagation();
        }

        // Caricamento ottimizzato mobile
        function loadModel(file) {
            console.log('📂 Caricamento mobile:', file.name);

            // Validazione
            const validExtensions = ['gltf', 'glb', 'dae'];
            currentFileExtension = file.name.split('.').pop().toLowerCase();
            
            if (!validExtensions.includes(currentFileExtension)) {
                showError(`Formato .${currentFileExtension} non supportato`);
                return;
            }

            // Limite ridotto per mobile se necessario
            const maxSize = isMobile ? 100 * 1024 * 1024 : 2 * 1024 * 1024 * 1024; // 100MB mobile, 2GB desktop
            if (file.size > maxSize) {
                showError(`File troppo grande. Max ${formatFileSize(maxSize)}`);
                return;
            }

            currentFileName = file.name;
            showLoading(`Caricando ${file.name}...`);

            // Leggi file
            const reader = new FileReader();
            reader.onload = function(event) {
                currentFileBlob = new Blob([event.target.result]);
                const url = URL.createObjectURL(currentFileBlob);
                
                loadInThreeJS(url, file.name);
                setupARViewer(url, file.name);
            };
            reader.readAsArrayBuffer(file);
        }

        function loadInThreeJS(url, filename) {
            let loader;
            switch(currentFileExtension) {
                case 'gltf':
                case 'glb':
                    loader = new THREE.GLTFLoader();
                    break;
                case 'dae':
                    loader = new THREE.ColladaLoader();
                    break;
            }
            
            loader.load(url, (result) => {
                if (model) {
                    scene.remove(model);
                }

                model = currentFileExtension === 'dae' ? result.scene : result.scene;
                setupThreeJSModel();
                updateUI(filename);
            }, undefined, (error) => {
                console.error('❌ Errore Three.js:', error);
                showError('Errore caricamento modello');
            });
        }

        function setupARViewer(url, filename) {
            if (currentFileExtension === 'glb' || currentFileExtension === 'gltf') {
                arViewer.src = url;
                arViewer.setAttribute('ios-src', url);
                arViewer.alt = `${filename} - MARIOPRO AR`;
                console.log('✅ AR configurato');
            }
        }

        function setupThreeJSModel() {
            // Setup ottimizzato mobile
            model.traverse((child) => {
                if (child.isMesh) {
                    if (!isMobile) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                    if (child.material) {
                        if (Array.isArray(child.material)) {
                            child.material.forEach(mat => mat.needsUpdate = true);
                        } else {
                            child.material.needsUpdate = true;
                        }
                    }
                }
            });

            centerAn
